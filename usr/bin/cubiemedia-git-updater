#!/bin/bash

# this script is only for none snap environment
restart_service () {
  systemctl is-active --quiet cubiemedia-$1
  RETURN=$?
  if [ $RETURN -eq 0 ]
  then
    systemctl restart cubiemedia-$1
  fi
}

echo "Checking for updates..."
STATUS=$(sudo -H -u pi bash -c 'git remote update && git status -uno')

if [[ $STATUS == *"Your branch is behind"* ]]
then
  echo "... update found ... "
  echo "... clean repository ..."
  git clean -f ./*/__pycache__
  git clean -f ./*/*/__pycache__
  echo "... stash changes ..."
  sudo -H -u pi bash -c 'git -c user.name="CubieMedia" -c user.email="info@cubiemedia.de" stash'
  echo "... pull changes ..."
  sudo -H -u pi bash -c 'git pull --ff-only'
  echo "... unstash changes ..."
  sudo -H -u pi bash -c 'git stash pop'
  echo "... finished update, restarting services"
  restart_service relay
  restart_service enocean
  restart_service victron
  restart_service gpio
  restart_service sonar
  restart_service miflora
  restart_service balboa
  restart_service git-updater
  restart_service webtool
else
  echo "... no updates found!"
fi
