#!/bin/bash

# this script is only for none snap environment
restart_service () {
  systemctl is-active --quiet cubiemedia-$1
  RETURN=$?
  if [ $RETURN -eq 0 ]
  then
    systemctl restart cubiemedia-$1
  fi
}

echo "Checking for updates..."
STATUS=$(sudo -H -u pi bash -c 'git remote update && git status -uno')

if [[ $STATUS == *"Your branch is behind"* ]]
then
  echo "... update found ... "
  echo "... pull changes (ff-only)..."
  sudo -H -u pi bash -c 'git pull --ff-only'
  echo "... installing dependencies ..."
  ./usr/bin/cubiemedia-install-dependencies
  echo "... restarting services ..."
  restart_service relay
  restart_service enocean
  restart_service victron
  restart_service gpio
  restart_service sonar
  restart_service miflora
  restart_service balboa
  restart_service git-updater
  restart_service webtool
  echo "finished update!"
else
  echo "no updates found!"
fi
